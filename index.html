<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ポケモンチェッカー</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800;900&display=swap" rel="stylesheet">
  <!-- アイコン -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { --background: #f8f9fa; --card: #ffffff; --primary: #3b82f6; }
    
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      background-color: var(--background);
      color: #1f2937;
      margin: 0;
      min-height: 100vh;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: none;
    }

    .glass-card {
      background-color: #ffffff;
      border-radius: 1.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      transform: translateZ(0);
    }
    
    .pokemon-title { font-weight: 900; letter-spacing: 0.02em; text-transform: uppercase; }
    .title-pokemon { color: #ffcb05; text-shadow: 3px 3px 0 #2a75bb; -webkit-text-stroke: 1.5px #2a75bb; }
    .title-checker { color: #2a75bb; text-shadow: 2px 2px 0 #ffcb05; }
    .type-badge { border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 800; letter-spacing: 0.05em; }
    .resist-label { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 900; margin-bottom: 0.5rem; }
    
    @media (min-width: 768px) { .resist-label { font-size: 0.85rem; padding: 0.3rem 0.8rem; } }

    /* タイプ色 */
    .bg-normal { background-color: #A8A77A; } .bg-fire { background-color: #EE8130; } .bg-water { background-color: #6390F0; } .bg-electric { background-color: #F7D02C; }
    .bg-grass { background-color: #7AC74C; } .bg-ice { background-color: #96D9D6; } .bg-fighting { background-color: #C22E28; } .bg-poison { background-color: #A33EA1; }
    .bg-ground { background-color: #E2BF65; } .bg-flying { background-color: #A98FF3; } .bg-psychic { background-color: #F95587; } .bg-bug { background-color: #A6B91A; }
    .bg-rock { background-color: #B6A136; } .bg-ghost { background-color: #735797; } .bg-dragon { background-color: #6F35FC; } .bg-dark { background-color: #705746; }
    .bg-steel { background-color: #B7B7CE; } .bg-fairy { background-color: #D685AD; }

    /* タイプ相性表 */
    .type-table-cell { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; border: 1px solid #e5e7eb; }
    .cell-2x { background-color: #fff1f2; color: #e11d48; } .cell-05x { background-color: #eff6ff; color: #2563eb; } .cell-0x { background-color: #f1f5f9; color: #64748b; } .cell-1x { background-color: #ffffff; }
    .sticky-col { position: sticky; left: 0; z-index: 10; border-right: 2px solid #e5e7eb; }
    .sticky-row { position: sticky; top: 0; z-index: 20; border-bottom: 2px solid #e5e7eb; height: 90px; }
    .sticky-corner { position: sticky; top: 0; left: 0; z-index: 30; background: white; border-right: 2px solid #e5e7eb; border-bottom: 2px solid #e5e7eb; height: 90px; width: 80px; }
    .writing-mode-vertical { writing-mode: vertical-rl; -ms-writing-mode: tb-rl; white-space: nowrap; display: flex; align-items: center; justify-content: center; padding: 4px 0; }
    
    .loader { border-top-color: #F87171; animation: spinner 1s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center relative pb-10">

  <div id="app-wrapper" class="w-full max-w-5xl mx-auto p-4 md:p-8">
    
    <div class="text-center mb-6 mt-4 md:mb-8">
      <h1 class="text-3xl md:text-5xl pokemon-title mb-2 md:mb-3">
        <span class="title-pokemon">ポケモン</span><span class="title-checker">チェッカー</span>
      </h1>
      <p class="text-slate-400 font-bold text-xs md:text-sm tracking-wide mb-4">弱点・種族値をサクッとチェック！</p>
      <button onclick="openTableModal()" class="inline-flex items-center gap-2 px-6 py-2.5 bg-white border-2 border-slate-100 rounded-full text-sm font-bold text-slate-600 shadow-sm hover:border-blue-300 hover:text-blue-500 transition-colors">
        <i data-lucide="grid-3x3" class="w-4 h-4"></i> タイプ相性表を見る
      </button>
    </div>

    <!-- 検索バー -->
    <div class="relative w-full max-w-xl mx-auto mb-4 z-30">
      <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
        <i data-lucide="search" class="text-slate-400 w-5 h-5"></i>
      </div>
      <input type="text" id="searchInput" placeholder="ポケモン名 (例: ラッタ)" autocomplete="off"
        class="w-full h-12 md:h-14 pl-12 pr-24 rounded-full border-2 border-slate-200 bg-white text-base md:text-lg font-bold placeholder-slate-300 focus:outline-none focus:border-blue-400 focus:ring-4 focus:ring-blue-50 transition-all shadow-sm relative z-20"
        onfocus="showSuggestions(true)" onblur="setTimeout(() => showSuggestions(false), 200)" oninput="filterSuggestions(this.value)" onkeydown="if(event.key === 'Enter') runSearch()">
      <button onclick="runSearch()" class="absolute right-2 top-1.5 md:top-2 h-9 md:h-10 px-5 md:px-6 bg-rose-400 hover:bg-rose-500 text-white rounded-full font-bold shadow-md transition-transform active:scale-95 text-xs md:text-sm z-20">検索</button>

      <div id="suggestList" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden z-10 p-2">
        <div id="historyArea">
          <div class="px-3 py-2 text-xs font-bold text-slate-400 flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> 検索履歴</div>
          <div id="historyList" class="flex flex-wrap gap-2 px-2 pb-2"></div>
        </div>
        <div id="predictArea" class="hidden">
          <div class="px-3 py-2 text-xs font-bold text-blue-400 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> 候補</div>
          <div id="predictList" class="flex flex-col"></div>
        </div>
      </div>
    </div>

    <!-- クイックナビ -->
    <div id="quickNav" class="w-full max-w-xl mx-auto mb-6 hidden">
      <div id="quickNavContent" class="flex flex-wrap gap-2 justify-center items-center bg-white/60 backdrop-blur-sm p-2 rounded-2xl border border-slate-100 shadow-sm min-h-[3rem]"></div>
    </div>

    <div id="loading" class="hidden flex-col items-center py-20">
      <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-10 w-10 mb-4"></div>
      <p class="text-rose-400 font-bold animate-pulse">データを読み込んでいます...</p>
    </div>

    <div id="error" class="hidden max-w-lg mx-auto bg-red-50 text-red-500 p-6 rounded-2xl text-center font-bold border border-red-100 mb-10 shadow-sm"></div>

    <div id="resultContainer" class="hidden space-y-12 animate-in fade-in slide-in-from-bottom-8 duration-500 pb-20"></div>
    
    <div id="moreLoading" class="hidden flex-col items-center py-10">
       <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-8 w-8 mb-2"></div>
       <p class="text-slate-400 text-xs">他の姿を読み込み中...</p>
    </div>
  </div>

  <!-- フッター -->
  <footer class="w-full max-w-5xl mx-auto mt-12 mb-8 px-4 text-center text-[10px] text-slate-400 leading-relaxed">
    <p class="mb-1">本アプリは個人の学習目的で作成された非公式のファンメイド作品です。</p>
    <p class="mb-1">任天堂株式会社・株式会社ポケモン・株式会社ゲームフリークとは一切関係ありません。</p>
    <p class="mb-3">ポケットモンスター・ポケモン・Pokémonは任天堂・クリーチャーズ・ゲームフリークの登録商標です。</p>
    <p>Data provided by <a href="https://pokeapi.co/" target="_blank" class="underline hover:text-slate-500">PokeAPI</a>.</p>
  </footer>

  <!-- モーダル群 -->
  <div id="tableModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden transition-opacity opacity-0" onclick="closeTableModal()">
    <div class="bg-white rounded-3xl w-full max-w-4xl h-[90vh] shadow-2xl transform scale-95 transition-transform border border-slate-100 flex flex-col overflow-hidden" onclick="event.stopPropagation()">
      <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-20 shrink-0">
        <div><h3 class="text-lg font-black text-slate-800 flex items-center gap-2"><i data-lucide="grid-3x3" class="w-5 h-5 text-blue-500"></i> タイプ相性表</h3><p class="text-xs text-slate-400 mt-1">縦が攻撃側、横が防御側です</p></div>
        <button onclick="closeTableModal()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
      </div>
      <div class="flex-1 overflow-auto p-4 bg-white" id="tableContainer"></div>
      <div class="p-3 bg-white border-t border-slate-100 text-xs flex justify-center gap-4 font-bold text-slate-500 shrink-0">
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[10px] text-rose-500">○</span> 2倍</span>
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[10px] text-blue-500">△</span> 0.5倍</span>
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded-full bg-white border border-slate-200 flex items-center justify-center text-[10px] text-slate-500">×</span> 0倍</span>
      </div>
    </div>
  </div>

  <div id="abilityModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden transition-opacity opacity-0" onclick="closeModal()">
    <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl transform scale-95 transition-transform border border-slate-100" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4"><h3 id="modalAbilityName" class="text-xl font-black text-slate-800"></h3><span id="modalHiddenBadge" class="hidden text-xs bg-rose-100 text-rose-500 px-2 py-1 rounded-md border border-rose-200 font-bold">夢特性</span></div>
      <p id="modalAbilityFlavor" class="text-slate-600 text-sm leading-relaxed font-medium bg-slate-50 p-4 rounded-2xl"></p>
      <button onclick="closeModal()" class="mt-6 w-full py-3.5 bg-slate-800 text-white font-bold rounded-2xl shadow-lg hover:bg-slate-700 transition-colors active:scale-95">閉じる</button>
    </div>
  </div>

  <script>
    // アイコン初期化
    lucide.createIcons();

    const typeJa = { normal:'ノーマル', fire:'ほのお', water:'みず', electric:'でんき', grass:'くさ', ice:'こおり', fighting:'かくとう', poison:'どく', ground:'じめん', flying:'ひこう', psychic:'エスパー', bug:'むし', rock:'いわ', ghost:'ゴースト', dragon:'ドラゴン', dark:'あく', steel:'はがね', fairy:'フェアリー' };
    const typeKeys = Object.keys(typeJa);
    const typeColors = { normal:'#A8A77A', fire:'#EE8130', water:'#6390F0', electric:'#F7D02C', grass:'#7AC74C', ice:'#96D9D6', fighting:'#C22E28', poison:'#A33EA1', ground:'#E2BF65', flying:'#A98FF3', psychic:'#F95587', bug:'#A6B91A', rock:'#B6A136', ghost:'#735797', dragon:'#6F35FC', dark:'#705746', steel:'#B7B7CE', fairy:'#D685AD' };
    
    // 辞書データ(圧縮)
    const DICT_STR = "フシギダネ:1,フシギソウ:2,フシギバナ:3,ヒトカゲ:4,リザード:5,リザードン:6,ゼニガメ:7,カメール:8,カメックス:9,キャタピー:10,トランセル:11,バタフリー:12,ビードル:13,コクーン:14,スピアー:15,ポッポ:16,ピジョン:17,ピジョット:18,コラッタ:19,ラッタ:20,オニスズメ:21,オニドリル:22,アーボ:23,アーボック:24,ピカチュウ:25,ライチュウ:26,サンド:27,サンドパン:28,ニドラン♀:29,ニドリーナ:30,ニドクイン:31,ニドラン♂:32,ニドリーノ:33,ニドキング:34,ピッピ:35,ピクシー:36,ロコン:37,キュウコン:38,プリン:39,プクリン:40,ズバット:41,ゴルバット:42,ナゾノクサ:43,クサイハナ:44,ラフレシア:45,パラス:46,パラセクト:47,コンパン:48,モルフォン:49,ディグダ:50,ダグトリオ:51,ニャース:52,ペルシアン:53,コダック:54,ゴルダック:55,マンキー:56,オコリザル:57,ガーディ:58,ウインディ:59,ニョロモ:60,ニョロゾ:61,ニョロボン:62,ケーシィ:63,ユンゲラー:64,フーディン:65,ワンリキー:66,ゴーリキー:67,カイリキー:68,マダツボミ:69,ウツドン:70,ウツボット:71,メノクラゲ:72,ドククラゲ:73,イシツブテ:74,ゴローン:75,ゴローニャ:76,ポニータ:77,ギャロップ:78,ヤドン:79,ヤドラン:80,コイル:81,レアコイル:82,カモネギ:83,ドードー:84,ドードリオ:85,パウワウ:86,ジュゴン:87,ベトベター:88,ベトベトン:89,シェルダー:90,パルシェン:91,ゴース:92,ゴースト:93,ゲンガー:94,イワーク:95,スリープ:96,スリーパー:97,クラブ:98,キングラー:99,ビリリダマ:100,マルマイン:101,タマタマ:102,ナッシー:103,カラカラ:104,ガラガラ:105,サワムラー:106,エビワラー:107,ベロリンガ:108,ドガース:109,マタドガス:110,サイホーン:111,サイドン:112,ラッキー:113,モンジャラ:114,ガルーラ:115,タッツー:116,シードラ:117,トサキント:118,アズマオウ:119,ヒトデマン:120,スターミー:121,バリヤード:122,ストライク:123,ルージュラ:124,エレブー:125,ブーバー:126,カイロス:127,ケンタロス:128,コイキング:129,ギャラドス:130,ラプラス:131,メタモン:132,イーブイ:133,シャワーズ:134,サンダース:135,ブースター:136,ポリゴン:137,オムナイト:138,オムスター:139,カブト:140,カブトプス:141,プテラ:142,カビゴン:143,フリーザー:144,サンダー:145,ファイヤー:146,ミニリュウ:147,ハクリュー:148,カイリュー:149,ミュウツー:150,ミュウ:151,チコリータ:152,ベイリーフ:153,メガニウム:154,ヒノアラシ:155,マグマラシ:156,バクフーン:157,ワニノコ:158,アリゲイツ:159,オーダイル:160,オタチ:161,オオタチ:162,ホーホー:163,ヨルノズク:164,レディバ:165,レディアン:166,イトマル:167,アリアドス:168,クロバット:169,チョンチー:170,ランターン:171,ピチュー:172,ピィ:173,ププリン:174,トゲピー:175,トゲチック:176,ネイティ:177,ネイティオ:178,メリープ:179,モココ:180,デンリュウ:181,キレイハナ:182,マリル:183,マリルリ:184,ウソッキー:185,ニョロトノ:186,ハネッコ:187,ポポッコ:188,ワタッコ:189,エイパム:190,ヒマナッツ:191,キマワリ:192,ヤンヤンマ:193,ウパー:194,ヌオー:195,エーフィ:196,ブラッキー:197,ヤミカラス:198,ヤドキング:199,ムウマ:200,アンノーン:201,ソーナンス:202,キリンリキ:203,クヌギダマ:204,フォレトス:205,ノコッチ:206,グライガー:207,ハガネール:208,ブルー:209,グランブル:210,ハリーセン:211,ハッサム:212,ツボツボ:213,ヘラクロス:214,ニューラ:215,ヒメグマ:216,リングマ:217,マグマッグ:218,マグカルゴ:219,ウリムー:220,イノムー:221,サニーゴ:222,テッポウオ:223,オクタン:224,デリバード:225,マンタイン:226,エアームド:227,デルビル:228,ヘルガー:229,キングドラ:230,ゴマゾウ:231,ドンファン:232,ポリゴン２:233,オドシシ:234,ドーブル:235,バルキー:236,カポエラー:237,ムチュール:238,エレキッド:239,ブビィ:240,ミルタンク:241,ハピナス:242,ライコウ:243,エンテイ:244,スイクン:245,ヨーギラス:246,サナギラス:247,バンギラス:248,ルギア:249,ホウオウ:250,セレビィ:251,キモリ:252,ジュプトル:253,ジュカイン:254,アチャモ:255,ワカシャモ:256,バシャーモ:257,ミズゴロウ:258,ヌマクロー:259,ラグラージ:260,ポチエナ:261,グラエナ:262,ジグザグマ:263,マッスグマ:264,ケムッソ:265,カラサリス:266,アゲハント:267,マユルド:268,ドクケイル:269,ハスボー:270,ハスブレロ:271,ルンパッパ:272,タネボー:273,コノハナ:274,ダーテング:275,スバメ:276,オオスバメ:277,キャモメ:278,ペリッパー:279,ラルトス:280,キルリア:281,サーナイト:282,アメタマ:283,アメモース:284,キノココ:285,キノガッサ:286,ナマケロ:287,ヤルキモノ:288,ケッキング:289,ツチニン:290,テッカニン:291,ヌケニン:292,ゴニョニョ:293,ドゴーム:294,バクオング:295,マクノシタ:296,ハリテヤマ:297,ルリリ:298,ノズパス:299,エネコ:300,エネコロロ:301,ヤミラミ:302,クチート:303,ココドラ:304,コドラ:305,ボスゴドラ:306,アサナン:307,チャーレム:308,ラクライ:309,ライボルト:310,プラスル:311,マイナン:312,バルビート:313,イルミーゼ:314,ロゼリア:315,ゴクリン:316,マルノーム:317,キバニア:318,サメハダー:319,ホエルコ:320,ホエルオー:321,ドンメル:322,バクーダ:323,コータス:324,バネブー:325,ブーピッグ:326,パッチール:327,ナックラー:328,ビブラーバ:329,フライゴン:330,サボネア:331,ノクタス:332,チルット:333,チルタリス:334,ザングース:335,ハブネーク:336,ルナトーン:337,ソルロック:338,ドジョッチ:339,ナマズン:340,ヘイガニ:341,シザリガー:342,ヤジロン:343,ネンドール:344,リリーラ:345,ユレイドル:346,アノプス:347,アーマルド:348,ヒンバス:349,ミロカロス:350,ポワルン:351,カクレオン:352,カゲボウズ:353,ジュペッタ:354,ヨマワル:355,サマヨール:356,トロピウス:357,チリーン:358,アブソル:359,ソーナノ:360,ユキワラシ:361,オニゴーリ:362,タマザラシ:363,トドグラー:364,トドゼルガ:365,パールル:366,ハンテール:367,サクラビス:368,ジーランス:369,ラブカス:370,タツベイ:371,コモルー:372,ボーマンダ:373,ダンバル:374,メタング:375,メタグロス:376,レジロック:377,レジアイス:378,レジスチル:379,ラティアス:380,ラティオス:381,カイオーガ:382,グラードン:383,レックウザ:384,ジラーチ:385,デオキシス:386,ナエトル:387,ハヤシガメ:388,ドダイトス:389,ヒコザル:390,モウカザル:391,ゴウカザル:392,ポッチャマ:393,ポッタイシ:394,エンペルト:395,ムックル:396,ムクバード:397,ムクホーク:398,ビッパ:399,ビーダル:400,コロボーシ:401,コロトック:402,コリンク:403,ルクシオ:404,レントラー:405,スボミー:406,ロズレイド:407,ズガイドス:408,ラムパルド:409,タテトプス:410,トリデプス:411,ミノムッチ:412,ミノマダム:413,ガーメイル:414,ミツハニー:415,ビークイン:416,パチリス:417,ブイゼル:418,フローゼル:419,チェリンボ:420,チェリム:421,カラナクシ:422,トリトドン:423,エテボース:424,フワンテ:425,フワライド:426,ミミロル:427,ミミロップ:428,ムウマージ:429,ドンカラス:430,ニャルマー:431,ブニャット:432,リーシャン:433,スカンプー:434,スカタンク:435,ドーミラー:436,ドータクン:437,ウソハチ:438,マネネ:439,ピンプク:440,ペラップ:441,ミカルゲ:442,フカマル:443,ガバイト:444,ガブリアス:445,ゴンベ:446,リオル:447,ルカリオ:448,ヒポポタス:449,カバルドン:450,スコルピ:451,ドラピオン:452,グレッグル:453,ドクロッグ:454,マスキッパ:455,ケイコウオ:456,ネオラント:457,タマンタ:458,ユキカブリ:459,ユキノオー:460,マニューラ:461,ジバコイル:462,ベロベルト:463,ドサイドン:464,モジャンボ:465,エレキブル:466,ブーバーン:467,トゲキッス:468,メガヤンマ:469,リーフィア:470,グレイシア:471,グライオン:472,マンムー:473,ポリゴンＺ:474,エルレイド:475,ダイノーズ:476,ヨノワール:477,ユキメノコ:478,ロトム:479,ユクシー:480,エムリット:481,アグノム:482,ディアルガ:483,パルキア:484,ヒードラン:485,レジギガス:486,ギラティナ:487,クレセリア:488,フィオネ:489,マナフィ:490,ダークライ:491,シェイミ:492,アルセウス:493,ビクティニ:494,ツタージャ:495,ジャノビー:496,ジャローダ:497,ポカブ:498,チャオブー:499,エンブオー:500,ミジュマル:501,フタチマル:502,ダイケンキ:503,ミネズミ:504,ミルホッグ:505,ヨーテリー:506,ハーデリア:507,ムーランド:508,チョロネコ:509,レパルダス:510,ヤナップ:511,ヤナッキー:512,バオップ:513,バオッキー:514,ヒヤップ:515,ヒヤッキー:516,ムンナ:517,ムシャーナ:518,マメパト:519,ハトーボー:520,ケンホロウ:521,シママ:522,ゼブライカ:523,ダンゴロ:524,ガントル:525,ギガイアス:526,コロモリ:527,ココロモリ:528,モグリュー:529,ドリュウズ:530,タブンネ:531,ドッコラー:532,ドテッコツ:533,ローブシン:534,オタマロ:535,ガマガル:536,ガマゲロゲ:537,ナゲキ:538,ダゲキ:539,クルミル:540,クルマユ:541,ハハコモリ:542,フシデ:543,ホイーガ:544,ペンドラー:545,モンメン:546,エルフーン:547,チュリネ:548,ドレディア:549,バスラオ:550,メグロコ:551,ワルビル:552,ワルビアル:553,ダルマッカ:554,ヒヒダルマ:555,マラカッチ:556,イシズマイ:557,イワパレス:558,ズルッグ:559,ズルズキン:560,シンボラー:561,デスマス:562,デスカーン:563,プロトーガ:564,アバゴーラ:565,アーケン:566,アーケオス:567,ヤブクロン:568,ダストダス:569,ゾロア:570,ゾロアーク:571,チラーミィ:572,チラチーノ:573,ゴチム:574,ゴチミル:575,ゴチルゼル:576,ユニラン:577,ダブラン:578,ランクルス:579,コアルヒー:580,スワンナ:581,バニプッチ:582,バニリッチ:583,バイバニラ:584,シキジカ:585,メブキジカ:586,エモンガ:587,カブルモ:588,シュバルゴ:589,タマゲタケ:590,モロバレル:591,プルリル:592,ブルンゲル:593,ママンボウ:594,バチュル:595,デンチュラ:596,テッシード:597,ナットレイ:598,ギアル:599,ギギアル:600,ギギギアル:601,シビシラス:602,シビビール:603,シビルドン:604,リグレー:605,オーベム:606,ヒトモシ:607,ランプラー:608,シャンデラ:609,キバゴ:610,オノンド:611,オノノクス:612,クマシュン:613,ツンベアー:614,フリージオ:615,チョボマキ:616,アギルダー:617,マッギョ:618,コジョフー:619,コジョンド:620,クリムガン:621,ゴビット:622,ゴルーグ:623,コマタナ:624,キリキザン:625,バッフロン:626,ワシボン:627,ウォーグル:628,バルチャイ:629,バルジーナ:630,クイタラン:631,アイアント:632,モノズ:633,ジヘッド:634,サザンドラ:635,メラルバ:636,ウルガモス:637,コバルオン:638,テラキオン:639,ビリジオン:640,トルネロス:641,ボルトロス:642,レシラム:643,ゼクロム:644,ランドロス:645,キュレム:646,ケルディオ:647,メロエッタ:648,ゲノセクト:649,ハリマロン:650,ハリボーグ:651,ブリガロン:652,フォッコ:653,テールナー:654,マフォクシー:655,ケロマツ:656,ゲコガシラ:657,ゲッコウガ:658,ホルビー:659,ホルード:660,ヤヤコマ:661,ヒノヤコマ:662,ファイアロー:663,コフキムシ:664,コフーライ:665,ビビヨン:666,シシコ:667,カエンジシ:668,フラベベ:669,フラエッテ:670,フラージェス:671,メェークル:672,ゴーゴート:673,ヤンチャム:674,ゴロンダ:675,トリミアン:676,ニャスパー:677,ニャオニクス:678,ヒトツキ:679,ニダンギル:680,ギルガルド:681,シュシュプ:682,フレフワン:683,ペロッパフ:684,ペロリーム:685,マーイーカ:686,カラマネロ:687,カメテテ:688,ガメノデス:689,クズモー:690,ドラミドロ:691,ウデッポウ:692,ブロスター:693,エリキテル:694,エレザード:695,チゴラス:696,ガチゴラス:697,アマルス:698,アマルルガ:699,ニンフィア:700,ルチャブル:701,デデンネ:702,メレシー:703,ヌメラ:704,ヌメイル:705,ヌメルゴン:706,クレッフィ:707,ボクレー:708,オーロット:709,バケッチャ:710,パンプジン:711,カチコール:712,クレベース:713,オンバット:714,オンバーン:715,ゼルネアス:716,イベルタル:717,ジガルデ:718,ディアンシー:719,フーパ:720,ボルケニオン:721,モクロー:722,フクスロー:723,ジュナイパー:724,ニャビー:725,ニャヒート:726,ガオガエン:727,アシマリ:728,オシャマリ:729,アシレーヌ:730,ツツケラ:731,ケララッパ:732,ドデカバシ:733,ヤングース:734,デカグース:735,アゴジムシ:736,デンヂムシ:737,クワガノン:738,マケンカニ:739,ケケンカニ:740,オドリドリ:741,アブリー:742,アブリボン:743,イワンコ:744,ルガルガン:745,ヨワシ:746,ヒドイデ:747,ドヒドイデ:748,ドロバンコ:749,バンバドロ:750,シズクモ:751,オニシズクモ:752,カリキリ:753,ラランテス:754,ネマシュ:755,マシェード:756,ヤトウモリ:757,エンニュート:758,ヌイコグマ:759,キテルグマ:760,アマカジ:761,アママイコ:762,アマージョ:763,キュワワー:764,ヤレユータ:765,ナゲツケサル:766,コソクムシ:767,グソクムシャ:768,スナバァ:769,シロデスナ:770,ナマコブシ:771,タイプ：ヌル:772,シルヴァディ:773,メテノ:774,ネッコアラ:775,バクガメス:776,トゲデマル:777,ミミッキュ:778,ハギギシリ:779,ジジーロン:780,ダダリン:781,ジャラコ:782,ジャランゴ:783,ジャラランガ:784,カプ・コケコ:785,カプ・テテフ:786,カプ・ブルル:787,カプ・レヒレ:788,コスモッグ:789,コスモウム:790,ソルガレオ:791,ルナアーラ:792,ウツロイド:793,マッシブーン:794,フェローチェ:795,デンジュモク:796,テッカグヤ:797,カミツルギ:798,アクジキング:799,ネクロズマ:800,マギアナ:801,マーシャドー:802,ベベノム:803,アーゴヨン:804,ツンデツンデ:805,ズガドーン:806,ゼラオラ:807,メルタン:808,メルメタル:809,サルノリ:810,バチンキー:811,ゴリランダー:812,ヒバニー:813,ラビフット:814,エースバーン:815,メッソン:816,ジメレオン:817,インテレオン:818,ホシガリス:819,ヨクバリス:820,ココガラ:821,アオガラス:822,アーマーガア:823,サッチムシ:824,レドームシ:825,イオルブ:826,クスネ:827,フォクスライ:828,ヒメンカ:829,ワタシラガ:830,ウールー:831,バイウールー:832,カムカメ:833,カジリガメ:834,ワンパチ:835,パルスワン:836,タンドン:837,トロッゴン:838,セキタンザン:839,カジッチュ:840,アップリュー:841,タルップル:842,スナヘビ:843,サダイジャ:844,ウッウ:845,サシカマス:846,カマスジョー:847,エレズン:848,ストリンダー:849,ヤクデ:850,マルヤクデ:851,タタッコ:852,オトスパス:853,ヤバチャ:854,ポットデス:855,ミブリム:856,テブリム:857,ブリムオン:858,ベロバー:859,ギモー:860,オーロンゲ:861,タチフサグマ:862,ニャイキング:863,サニゴーン:864,ネギガナイト:865,バリコオル:866,デスバーン:867,マホミル:868,マホイップ:869,タイレーツ:870,バチンウニ:871,ユキハミ:872,モスノウ:873,イシヘンジン:874,コオリッポ:875,イエッサン:876,モルペコ:877,ゾウドウ:878,ダイオウドウ:879,パッチラゴン:880,パッチルドン:881,ウオノラゴン:882,ウオチルドン:883,ジュラルドン:884,ドラメシヤ:885,ドロンチ:886,ドラパルト:887,ザシアン:888,ザマゼンタ:889,ムゲンダイナ:890,ダクマ:891,ウーラオス:892,バドレックス:898,ニャオハ:906,ニャローテ:907,マスカーニャ:908,ホゲータ:909,アチゲータ:910,ラウドボーン:911,クワッス:912,ウェルカモ:913,ウェーニバル:914,グルトン:915,パフュートン:916,タマンチュラ:917,ワナイダー:918,マメバッタ:919,エクスレッグ:920,パモ:921,パモット:922,パーモット:923,イッカネズミ:924,パピモッチ:925,バウッツェル:926,ミニーブ:927,オリーニョ:928,オリーヴァ:929,コジオ:930,ジオヅム:931,キョジオーン:932,カルボウ:933,グレンアルマ:934,ソウブレイズ:935,ズピカ:936,ハラバリー:937,カイデン:938,タイカイデン:939,オラチフ:940,マフィティフ:941,シルシュルー:942,タギングル:943,アノクサ:944,アノホラグサ:945,ノノクラゲ:946,リククラゲ:947,ガケガニ:948,カプサイジ:949,スコヴィラン:950,シガロコ:951,ベラカス:952,ヒラヒナ:953,クエスパトラ:954,カヌチャン:955,ナカヌチャン:956,デカヌチャン:957,ウミディグダ:958,ウミトリオ:959,オトシドリ:960,ナミイルカ:961,イルカマン:962,ブロロン:963,ブロロローム:964,モトトカゲ:965,ミミズズ:966,キラーメ:967,キラフロル:968,ボチ:969,ハカドッグ:970,カラミンゴ:971,アルクジラ:972,ハルクジラ:973,ミガルーサ:974,ヘイラッシャ:975,シャリタツ:976,コノヨザル:977,ドオー:978,リキキリン:979,ノココッチ:980,ドドゲザン:981,イダイナキバ:982,サケブシッポ:983,アラブルタケ:984,ハバタクカミ:985,チヲハウハネ:986,スナノケガワ:987,テツノワダチ:988,テツノツツミ:989,テツノカイナ:990,テツノコウベ:991,テツノドクガ:992,テツノイバラ:993,セビエ:994,セゴール:995,セグレイブ:996,コレクレー:997,サーフゴー:998,チオンジェン:999,パオジアン:1000,ディンルー:1001,イーユイ:1002,トドロクツキ:1003,テツノブジン:1004,コライドン:1005,ミライドン:1006,ウネルミナモ:1007,テツノイサハ:1008,カミッチュ:1009,チャデス:1010,ヤバソチャ:1011,イイネイヌ:1012,マシマシラ:1013,キチキギス:1014,オーガポン:1015,ブリジュラス:1016,カミツオロチ:1017,ウガツホムラ:1018,タケルライコ:1019,テツノイワオ:1020,テツノカシラ:1021,テラパゴス:1022,モモワロウ:1023,ラッタ(アローラ):10092,ライチュウ(アローラ):10100,ロコン(アローラ):10103,キュウコン(アローラ):10104,ディグダ(アローラ):10105,ダグトリオ(アローラ):10106,ニャース(アローラ):10107,ペルシアン(アローラ):10108,イシツブテ(アローラ):10109,ゴローン(アローラ):10110,ゴローニャ(アローラ):10111,ベトベター(アローラ):10112,ベトベトン(アローラ):10113,ナッシー(アローラ):10114,ガラガラ(アローラ):10115,ニャース(ガラル):10161,ポニータ(ガラル):10162,ギャロップ(ガラル):10163,ヤドン(ガラル):10164,ヤドラン(ガラル):10165,カモネギ(ガラル):10166,マタドガス(ガラル):10167,バリヤード(ガラル):10168,デスマス(ガラル):10169,マッスグマ(ガラル):10170,ダルマッカ(ガラル):10171,ヒヒダルマ(ガラル):10172,サンダー(ガラル):10184,ファイヤー(ガラル):10185,フリーザー(ガラル):10186,ヤドキング(ガラル):10187,カメックス(キョダイ):10191,リザードン(キョダイ):10192,フシギバナ(キョダイ):10193,ピカチュウ(キョダイ):10199,イーブイ(キョダイ):10205,ニャース(キョダイ):10204,ジュラルドン(キョダイ):10227,ゲンガー(キョダイ):10202";

    const dict = {};
    const idToName = {}; 
    const SUGGEST_DICT = []; // サジェスト候補用

    // 辞書オブジェクト生成 & サジェスト用リスト作成
    DICT_STR.split(',').forEach(pair => {
      const parts = pair.split(':');
      if(parts.length === 2) {
        const name = parts[0];
        const id = parseInt(parts[1], 10);
        dict[name] = id;
        idToName[id] = name;
        SUGGEST_DICT.push(name);
      }
    });

    // 相性マトリクス
    const typeMatrix={normal:{rock:2,ghost:3,steel:2},fire:{fire:2,water:2,grass:1,ice:1,bug:1,rock:2,dragon:2,steel:1},water:{fire:1,water:2,grass:2,ground:1,rock:1,dragon:2},electric:{water:1,electric:2,grass:2,ground:3,flying:1,dragon:2},grass:{fire:2,water:1,grass:2,poison:2,ground:1,flying:2,bug:2,rock:1,dragon:2,steel:2},ice:{fire:2,water:2,grass:1,ice:2,ground:1,flying:1,dragon:1,steel:2},fighting:{normal:1,ice:1,poison:2,flying:2,psychic:2,bug:2,rock:1,ghost:3,dark:1,steel:1,fairy:2},poison:{grass:1,poison:2,ground:2,rock:2,ghost:2,steel:3,fairy:1},ground:{fire:1,electric:1,grass:2,poison:1,flying:3,bug:2,rock:1,steel:1},flying:{electric:2,grass:1,fighting:1,bug:1,rock:2,steel:2},psychic:{fighting:1,poison:1,psychic:2,dark:3,steel:2},bug:{fire:2,grass:1,fighting:2,poison:2,flying:2,psychic:1,ghost:2,dark:1,steel:2,fairy:2},rock:{fire:1,ice:1,fighting:2,ground:2,flying:1,bug:1,steel:2},ghost:{normal:3,psychic:1,ghost:1,dark:2},dragon:{dragon:1,steel:2,fairy:3},dark:{fighting:2,psychic:1,ghost:1,dark:2,fairy:2},steel:{fire:2,water:2,electric:2,ice:1,rock:1,steel:2,fairy:1},fairy:{fire:2,fighting:1,poison:2,dragon:1,dark:1,steel:2}};

    window.onload = function() { loadHistory(); };

    // --- メイン検索処理 ---
    async function runSearch() {
      const val = document.getElementById('searchInput').value;
      if(!val) return;

      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('resultContainer').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('suggestList').classList.add('hidden');
      document.getElementById('quickNav').classList.add('hidden');
      document.getElementById('moreLoading').classList.add('hidden');
      document.getElementById('resultContainer').innerHTML = ''; // クリア
      
      saveHistory(val);

      try {
        let searchId = val.trim();
        // 辞書チェック
        if (dict[searchId]) {
          searchId = dict[searchId];
        } else {
          // 辞書にない場合は英語名として小文字化
          searchId = searchId.toLowerCase();
        }

        // 1. まずメインポケモンを取得 (1匹目)
        const mainData = await fetchPokemonData(searchId);
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('resultContainer').classList.remove('hidden');
        
        // メインカード表示
        const container = document.getElementById('resultContainer');
        container.innerHTML += createCardHTML(mainData);
        updateQuickNav(mainData);
        lucide.createIcons();

        // 2. 関連する姿 (メガシンカ等) があれば遅延ロード
        if (mainData.variations && mainData.variations.length > 0) {
            loadVariations(mainData.variations);
        }

      } catch (e) {
        document.getElementById('loading').classList.add('hidden');
        showError("ポケモンが見つかりませんでした");
        console.error(e);
      }
    }

    // --- 関連する姿の遅延ロード ---
    async function loadVariations(variations) {
        document.getElementById('moreLoading').classList.remove('hidden');
        const container = document.getElementById('resultContainer');
        
        for (const v of variations) {
            try {
                // IDで取得
                const data = await fetchPokemonData(v.targetId);
                // 重複チェック
                if (!document.getElementById(data.uniqueId || 'poke-'+data.id)) {
                    container.innerHTML += createCardHTML(data);
                }
            } catch (e) {
                console.warn("Failed to load variation:", v.name, e);
            }
        }
        document.getElementById('moreLoading').classList.add('hidden');
        lucide.createIcons();
    }

    // --- データ取得ロジック (API直接呼び出し) ---
    async function fetchPokemonData(idOrName) {
        // 基本データ
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${idOrName}`);
        if (!res.ok) throw new Error("Not Found");
        const data = await res.json();

        // Speciesデータ (日本語名など)
        const speciesRes = await fetch(data.species.url);
        const species = await speciesRes.json();

        // 日本語名決定
        let jaName = species.names.find(x => x.language.name === 'ja')?.name || data.name;
        
        // フォーム名補正 (簡易)
        if (data.name !== species.name) {
             const suffix = data.name.replace(species.name + '-', '');
             if (suffix === 'mega') jaName = "メガ" + jaName;
             else if (suffix === 'mega-x') jaName = "メガ" + jaName + " X";
             else if (suffix === 'mega-y') jaName = "メガ" + jaName + " Y";
             else if (suffix === 'alola') jaName = jaName + "(アローラ)";
             else if (suffix === 'galar') jaName = jaName + "(ガラル)";
             else if (suffix === 'hisui') jaName = jaName + "(ヒスイ)";
             else if (suffix === 'paldea') jaName = jaName + "(パルデア)";
             else if (suffix === 'gmax') jaName = jaName + "(キョダイ)";
             else if (suffix === 'primal') jaName = "ゲンシ" + jaName;
        }

        // タイプ相性計算用のURLリスト
        const typeUrls = data.types.map(t => t.type.url);
        const typeDetails = await Promise.all(typeUrls.map(url => fetch(url).then(r => r.json())));

        // 特性 (日本語化)
        const abilityPromises = data.abilities.map(async a => {
            const r = await fetch(a.ability.url);
            const j = await r.json();
            const n = j.names.find(x => x.language.name === 'ja')?.name || a.ability.name;
            const f = (j.flavor_text_entries.find(x => x.language.name === 'ja') || {}).flavor_text || "";
            return { name: n, is_hidden: a.is_hidden, flavor: f.replace(/\r?\n|\f/g, '') };
        });
        const abilities = await Promise.all(abilityPromises);

        // 進化情報取得 (非同期)
        const evoRes = await fetch(species.evolution_chain.url);
        const evoJson = await evoRes.json();
        const evolution = parseEvolution(evoJson.chain, species.name);

        // 関連する姿 (リスト作成のみ)
        let variations = [];
        const allowedSuffixes = ["mega", "alola", "galar", "hisui", "paldea", "gmax", "primal", "origin", "therian"];
        if (species.varieties.length > 1) {
            species.varieties.forEach(v => {
                if (v.pokemon.name === data.name) return; // 自分は除外
                const parts = v.pokemon.name.split('-');
                if (allowedSuffixes.some(s => v.pokemon.name.includes(s))) {
                     // ID抽出
                     const urlParts = v.pokemon.url.split('/');
                     const vId = urlParts[urlParts.length - 2];
                     
                     // 名前解決 (辞書にあればそれ、なければ仮名)
                     let vName = v.pokemon.name;
                     if(idToName[vId]) vName = idToName[vId];
                     else {
                         // 簡易置換
                         vName = vName.replace(species.name+'-', '');
                         if(vName==='mega') vName='メガ';
                         if(vName==='mega-x') vName='メガX';
                         if(vName==='mega-y') vName='メガY';
                         if(vName==='gmax') vName='キョダイ';
                     }
                     variations.push({ name: vName, targetId: vId });
                }
            });
        }

        const genus = (species.genera.find(x => x.language.name === 'ja') || {}).genus || "";
        const flavor = (species.flavor_text_entries.find(x => x.language.name === 'ja') || {}).flavor_text || "";

        return {
            id: data.id,
            uniqueId: "poke-" + data.id,
            name: jaName,
            genus: genus,
            image: data.sprites.other['official-artwork'].front_default || data.sprites.front_default,
            flavor: flavor.replace(/\r?\n|\f/g, ''),
            height: data.height,
            weight: data.weight,
            types: data.types.map(t => t.type.name),
            stats: data.stats.map(s => ({ name: s.stat.name, base: s.base_stat })),
            abilities: abilities,
            typeDetails: typeDetails,
            evolution: evolution,
            variations: variations
        };
    }

    // 進化解析 (JS版)
    function parseEvolution(chain, currentName) {
        let result = { pre: null, next: [] };
        
        function extractIdFromUrl(url) {
            if (!url) return null;
            const parts = url.split('/').filter(Boolean);
            return parseInt(parts[parts.length - 1], 10);
        }

        function getNameFromNode(node) {
            const id = extractIdFromUrl(node.species.url);
            return idToName[id] || node.species.name; // ID辞書から日本語名を取得、なければ英語名
        }

        function traverse(node, prevNode) {
            // PokeAPIのspecies.nameは英語小文字
            if (node.species.name === currentName) {
                if (prevNode) result.pre = getNameFromNode(prevNode);
                if (node.evolves_to.length > 0) {
                    result.next = node.evolves_to.map(e => getNameFromNode(e));
                }
                return true;
            }
            for (let i = 0; i < node.evolves_to.length; i++) {
                if (traverse(node.evolves_to[i], node)) return true;
            }
            return false;
        }
        traverse(chain, null);
        return result;
    }

    // --- UI操作系 ---
    function updateQuickNav(data) {
        const nav = document.getElementById('quickNav');
        const content = document.getElementById('quickNavContent');
        content.innerHTML = '';
        let hasNav = false;
        
        if (data.evolution) {
            if (data.evolution.pre) {
                hasNav = true;
                content.innerHTML += `<button onclick="setSearch('${data.evolution.pre}')" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full text-xs font-bold transition-colors flex items-center gap-1"><i data-lucide="arrow-left" class="w-3 h-3"></i> ${data.evolution.pre}</button>`;
            }
            if (data.evolution.next && data.evolution.next.length > 0) {
                hasNav = true;
                data.evolution.next.forEach(nextName => {
                    content.innerHTML += `<button onclick="setSearch('${nextName}')" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full text-xs font-bold transition-colors flex items-center gap-1">${nextName} <i data-lucide="arrow-right" class="w-3 h-3"></i></button>`;
                });
            }
        }
        
        if (data.variations && data.variations.length > 0) {
            hasNav = true;
            content.innerHTML += `<span class="text-[10px] font-bold text-slate-400 mr-1 ml-2">他の姿:</span>`;
            data.variations.forEach(v => {
                content.innerHTML += `<button onclick="scrollToCard('${v.targetId}')" class="px-3 py-1.5 bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-500 text-slate-500 rounded-full text-xs font-bold transition-colors flex items-center gap-1.5 shadow-sm"><span class="w-2 h-2 rounded-full bg-blue-400"></span> ${v.name}</button>`;
            });
        }

        if (hasNav) nav.classList.remove('hidden'); else nav.classList.add('hidden');
    }

    function createCardHTML(data) {
        let mults = {};
        data.typeDetails.forEach(td => {
            td.damage_relations.double_damage_from.forEach(d => mults[d.name] = (mults[d.name] || 1) * 2);
            td.damage_relations.half_damage_from.forEach(d => mults[d.name] = (mults[d.name] || 1) * 0.5);
            td.damage_relations.no_damage_from.forEach(d => mults[d.name] = 0);
        });

        const typesHTML = data.types.map(t => `<span class="type-badge px-3 py-1 rounded-full text-white text-xs" style="background-color:${typeColors[t]}">${typeJa[t]}</span>`).join('');
        
        const abilitiesHTML = data.abilities.map(a => {
            const safeName = a.name.replace(/'/g, "\\'");
            const safeFlavor = (a.flavor || "").replace(/'/g, "\\'").replace(/\n/g, "");
            return `<div class="mb-3 last:mb-0 group">
                <button onclick="openModal('${safeName}', ${a.is_hidden}, '${safeFlavor}')" class="w-full text-left flex items-center flex-wrap gap-1 md:cursor-default">
                    <span class="font-bold text-slate-700 text-sm border-b border-dashed border-slate-300 md:border-0 pb-0.5 md:pb-0">${a.name}</span>
                    ${a.is_hidden ? '<span class="text-[10px] bg-rose-100 text-rose-500 px-1.5 py-0.5 rounded border border-rose-200 font-bold">夢特性</span>' : ''}
                    <i data-lucide="info" class="w-3 h-3 text-slate-400 md:hidden ml-1"></i>
                </button>
                <div class="hidden md:block text-xs text-slate-500 mt-1 leading-relaxed">${a.flavor || ''}</div>
            </div>`;
        }).join('');

        // 弱点表示
        let w4=[], w2=[], r05=[], r025=[], r0=[];
        Object.entries(mults).forEach(([t, m]) => {
            const badge = `<span class="type-badge px-2.5 py-1 rounded-full text-white text-[10px]" style="background-color:${typeColors[t]}">${typeJa[t]}</span>`;
            if (m===4) w4.push(badge); else if (m===2) w2.push(badge); else if (m===0.5) r05.push(badge); else if (m===0.25) r025.push(badge); else if (m===0) r0.push(badge);
        });

        let weaknessContent = '';
        if(w4.length) weaknessContent += `<div class="mb-3"><span class="resist-label bg-rose-100 text-rose-600">4倍弱点</span><div class="flex flex-wrap gap-1.5">${w4.join('')}</div></div>`;
        if(w2.length) weaknessContent += `<div class="mb-3"><span class="resist-label bg-orange-100 text-orange-600">2倍弱点</span><div class="flex flex-wrap gap-1.5">${w2.join('')}</div></div>`;
        
        let resistBlocks = '';
        if(r05.length) resistBlocks += `<div class="mb-3"><span class="resist-label bg-blue-100 text-blue-600">0.5倍 (半減)</span><div class="flex flex-wrap gap-1.5 opacity-90">${r05.join('')}</div></div>`;
        if(r025.length) resistBlocks += `<div class="mb-3"><span class="resist-label bg-indigo-100 text-indigo-600">0.25倍 (激減)</span><div class="flex flex-wrap gap-1.5 opacity-90">${r025.join('')}</div></div>`;
        if(r0.length) resistBlocks += `<div class="mb-3"><span class="resist-label bg-slate-200 text-slate-600">0倍 (無効)</span><div class="flex flex-wrap gap-1.5 opacity-90">${r0.join('')}</div></div>`;
        
        if(resistBlocks) weaknessContent += `<div class="pt-4 border-t border-slate-100 mt-2">${resistBlocks}</div>`;
        if(!weaknessContent) weaknessContent = `<div class="text-slate-400 text-sm font-bold">弱点・耐性はありません</div>`;

        // 種族値
        let total = 0;
        const sMap = {hp:'HP', attack:'こうげき', defense:'ぼうぎょ', 'special-attack':'とくこう', 'special-defense':'とくぼう', speed:'すばやさ'};
        const cMap = {hp:'bg-red-400', attack:'bg-orange-400', defense:'bg-yellow-400', 'special-attack':'bg-blue-400', 'special-defense':'bg-green-400', speed:'bg-pink-400'};
        const statsHTML = data.stats.map(s => {
            total += s.base;
            const w = Math.min((s.base / 160) * 100, 100);
            return `<div class="flex items-center text-sm font-bold"><div class="w-14 text-slate-400 text-xs">${sMap[s.name]}</div><div class="w-8 text-right mr-3 text-slate-700 text-sm">${s.base}</div><div class="flex-1 bg-slate-100 rounded-full h-2 overflow-hidden"><div class="h-full rounded-full ${cMap[s.name]}" style="width: ${w}%"></div></div></div>`;
        }).join('');

        return `
        <div id="${data.uniqueId || 'poke-'+data.id}" class="grid grid-cols-1 md:grid-cols-12 gap-6 scroll-mt-24 relative fade-in">
            <!-- 左カラム -->
            <div class="md:col-span-5 glass-card p-6 relative overflow-hidden">
                <div class="relative z-10 flex flex-col items-center">
                    <div class="flex flex-row md:flex-col items-center gap-4 w-full">
                        <div class="shrink-0 relative">
                            <div class="w-24 h-24 md:w-56 md:h-56 bg-white rounded-2xl md:rounded-full flex items-center justify-center shadow-md border-2 md:border-4 border-white my-2 md:my-6">
                                <img src="${data.image}" class="w-20 h-20 md:w-44 md:h-44 object-contain drop-shadow-md">
                            </div>
                        </div>
                        <div class="flex flex-col w-full text-left md:text-center">
                            <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-start w-full mb-2">
                                <div class="text-left">
                                    <h2 class="text-xl md:text-3xl font-black text-slate-800 tracking-tight leading-none">${data.name}</h2>
                                    <p class="text-xs text-slate-400 mt-1 font-bold">${data.genus}</p>
                                </div>
                                <span class="bg-slate-100 text-slate-400 px-2 py-0.5 rounded text-xs font-black">#${data.id.toString().padStart(4,'0')}</span>
                            </div>
                            <div class="flex flex-wrap gap-1.5 md:justify-center mt-2 mb-4">${typesHTML}</div>
                            <div class="flex gap-3 w-full">
                                <div class="bg-slate-50 rounded-lg px-2 py-1.5 border border-slate-100 flex-1 text-center"><span class="text-xs text-slate-400 font-bold block">たかさ</span><span class="text-sm font-black text-slate-700">${data.height/10} m</span></div>
                                <div class="bg-slate-50 rounded-lg px-2 py-1.5 border border-slate-100 flex-1 text-center"><span class="text-xs text-slate-400 font-bold block">おもさ</span><span class="text-sm font-black text-slate-700">${data.weight/10} kg</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full bg-white rounded-xl p-4 text-left mt-4 border border-slate-100 shadow-sm">
                        <div class="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> とくせい</div>
                        <div class="space-y-2">${abilitiesHTML}</div>
                    </div>
                    <p class="hidden md:block text-sm text-slate-500 font-medium leading-relaxed bg-slate-50 p-4 rounded-xl w-full text-left mt-4">${data.flavor}</p>
                </div>
            </div>

            <!-- 右カラム -->
            <div class="md:col-span-7 flex flex-col gap-6">
                <div class="glass-card p-6">
                    <h3 class="font-black text-slate-800 mb-4 text-lg flex items-center gap-2"><i data-lucide="swords" class="w-5 h-5 text-rose-400"></i> タイプ相性</h3>
                    <div class="space-y-2">${weaknessContent}</div>
                </div>
                <div class="glass-card p-6 flex-1">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-black text-slate-800 text-lg flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-400"></i> 種族値</h3>
                        <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100">合計: <span class="text-slate-600 ml-1">${total}</span></span>
                    </div>
                    <div class="space-y-3">${statsHTML}</div>
                </div>
            </div>
        </div>
        `;
    }

    function scrollToCard(id){
       let targetId = id;
       if (!id.startsWith('poke-')) { targetId = 'poke-' + id; }
       const el=document.getElementById(targetId);
       if(el){el.scrollIntoView({behavior:'smooth',block:'start'});}
    }
    
    // UIヘルパー関数
    function renderTypeTable(){const container=document.getElementById('tableContainer');let html='<table class="border-separate border-spacing-0 text-center text-xs">';html+='<thead><tr><th class="p-0 sticky-corner z-30 bg-white border-r-2 border-b-2 border-slate-200"><div class="w-full h-full flex flex-col items-center justify-center text-[9px] text-slate-400 font-bold bg-slate-50"><span class="block">防御➡</span><span class="block">攻撃⬇</span></div></th>';typeKeys.forEach(t=>{html+=`<th class="p-0 sticky-row z-20 text-white border-b-2 border-slate-200 min-w-[40px]" style="background-color:${typeColors[t]}"><div class="writing-mode-vertical h-full w-full flex items-center justify-center font-bold tracking-widest">${typeJa[t]}</div></th>`});html+='</tr></thead><tbody>';typeKeys.forEach(atk=>{html+=`<tr><th class="p-0 sticky-col z-10 text-white border-r-2 border-slate-200" style="background-color:${typeColors[atk]}"><div class="h-[40px] flex items-center justify-center font-bold px-2 text-[11px]">${typeJa[atk]}</div></th>`;typeKeys.forEach(def=>{let effect=0;const rel=typeMatrix[atk];if(rel&&rel[def]!==undefined){effect=rel[def]}let cellClass="type-table-cell";let mark="";if(effect===1){cellClass+=" cell-2x";mark="○"}else if(effect===2){cellClass+=" cell-05x";mark="△"}else if(effect===3){cellClass+=" cell-0x";mark="×"}else{cellClass+=" cell-1x"}html+=`<td class="p-0 border border-slate-100"><div class="${cellClass}">${mark}</div></td>`});html+='</tr>'});html+='</tbody></table>';container.innerHTML=html}
    function openTableModal(){renderTypeTable();const modal=document.getElementById('tableModal');modal.classList.remove('hidden');setTimeout(()=>{modal.classList.remove('opacity-0');modal.querySelector('div').classList.remove('scale-95');modal.querySelector('div').classList.add('scale-100')},10)}
    function closeTableModal(){const modal=document.getElementById('tableModal');modal.classList.add('opacity-0');modal.querySelector('div').classList.remove('scale-100');modal.querySelector('div').classList.add('scale-95');setTimeout(()=>{modal.classList.add('hidden')},300)}
    function showSuggestions(show){const list=document.getElementById('suggestList');if(show){list.classList.remove('hidden')}else{setTimeout(()=>list.classList.add('hidden'),200)}}
    function filterSuggestions(val){const h=document.getElementById('historyArea');const p=document.getElementById('predictArea');const l=document.getElementById('predictList');if(!val){h.classList.remove('hidden');p.classList.add('hidden');return}h.classList.add('hidden');p.classList.remove('hidden');let hits=SUGGEST_DICT.filter(n=>n.includes(val));if(hits.length>0){l.innerHTML=hits.map(n=>`<button onclick="setSearch('${n}')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-slate-700 font-bold border-b border-slate-50 last:border-0 transition-colors flex items-center gap-2"><i data-lucide="search" class="w-3 h-3 text-slate-300"></i> ${n}</button>`).join('');lucide.createIcons()}else{l.innerHTML=`<div class="px-3 py-2 text-slate-400 text-sm">候補なし</div>`}}
    function setSearch(name){document.getElementById('searchInput').value=name;runSearch()}
    function openModal(name,isHidden,flavor){if(window.innerWidth>=768)return;document.getElementById('modalAbilityName').innerText=name;document.getElementById('modalAbilityFlavor').innerText=flavor||'説明文がありません';const badge=document.getElementById('modalHiddenBadge');if(isHidden)badge.classList.remove('hidden');else badge.classList.add('hidden');const modal=document.getElementById('abilityModal');modal.classList.remove('hidden');setTimeout(()=>{modal.classList.remove('opacity-0');modal.querySelector('div').classList.remove('scale-95');modal.querySelector('div').classList.add('scale-100')},10)}
    function closeModal(){const modal=document.getElementById('abilityModal');modal.classList.add('opacity-0');modal.querySelector('div').classList.remove('scale-100');modal.querySelector('div').classList.add('scale-95');setTimeout(()=>{modal.classList.add('hidden')},300)}
    function loadHistory(){const history=JSON.parse(localStorage.getItem('poke_history')||'[]');renderHistory(history)}
    function saveHistory(name){let history=JSON.parse(localStorage.getItem('poke_history')||'[]');history=history.filter(h=>h!==name);history.unshift(name);if(history.length>5)history.pop();localStorage.setItem('poke_history',JSON.stringify(history));renderHistory(history)}
    function renderHistory(history){const el=document.getElementById('historyList');if(history.length===0){el.innerHTML='<span class="text-xs text-slate-300 px-2">履歴なし</span>';return}el.innerHTML=history.map(name=>`<button onclick="setSearch('${name}')" class="bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded-full text-sm text-slate-600 font-bold transition-colors">${name}</button>`).join('')}
    function showError(msg){const err=document.getElementById('error');err.innerText=msg;err.classList.remove('hidden')}
  </script>
</body>
</html>
